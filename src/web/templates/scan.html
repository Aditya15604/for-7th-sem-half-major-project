<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>New Scan | Cyber Triage Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=2">
    <style>
        .scan-container {
            max-width: 800px;
            margin: 50px auto;
        }
        .progress-section {
            display: none;
            margin-top: 30px;
        }
        .scan-result {
            display: none;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}
    
    <div class="container scan-container">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h3><i class="bi bi-radar"></i> Initiate Security Scan</h3>
            </div>
            <div class="card-body">
                <form id="scanForm">
                    <div class="mb-3">
                        <label for="targetPath" class="form-label">Target Path</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="targetPath" 
                                   placeholder="C:\Users\Example\Documents" required>
                            <button class="btn btn-outline-secondary" type="button" 
                                    data-bs-toggle="modal" data-bs-target="#browserModal">
                                <i class="bi bi-folder2-open"></i> Browse
                            </button>
                        </div>
                        <div class="form-text">Enter the directory path to scan or click Browse</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scanType" class="form-label">Scan Type</label>
                        <select class="form-select" id="scanType">
                            <option value="quick" selected>Quick Scan (Fast, Basic Analysis)</option>
                            <option value="full">Full Analysis (Comprehensive, Slower)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableYara" checked>
                            <label class="form-check-label" for="enableYara">
                                Enable YARA Malware Detection
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enablePE" checked>
                            <label class="form-check-label" for="enablePE">
                                Enable PE File Analysis
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="bi bi-play-circle"></i> Start Scan
                    </button>
                </form>
                
                <div class="progress-section" id="progressSection">
                    <h5>Scan in Progress...</h5>
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" id="progressBar" style="width: 0%">0%</div>
                    </div>
                    <p class="mt-2 text-muted" id="progressText">Initializing scan...</p>
                </div>
                
                <div class="scan-result alert alert-success" id="scanResult">
                    <h5><i class="bi bi-check-circle"></i> Scan Completed!</h5>
                    <p id="resultText"></p>
                    <a href="#" id="viewReportBtn" class="btn btn-success">View Report</a>
                </div>
                
                <div class="scan-result alert alert-danger" id="scanError" style="display: none;">
                    <h5><i class="bi bi-x-circle"></i> Scan Failed</h5>
                    <p id="errorText"></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- File Browser Modal -->
    <div class="modal fade" id="browserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-folder2-open"></i> Browse Directories</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Current Path:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="currentPath" readonly>
                            <button class="btn btn-outline-secondary" onclick="goUp()">
                                <i class="bi bi-arrow-up"></i> Up
                            </button>
                        </div>
                    </div>
                    <div id="browserContent" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="selectCurrentPath()">
                        <i class="bi bi-check-circle"></i> Select This Folder
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('scanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const targetPath = document.getElementById('targetPath').value;
            const scanType = document.getElementById('scanType').value;
            
            // Show progress section
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('scanResult').style.display = 'none';
            document.getElementById('scanError').style.display = 'none';
            document.querySelector('form').style.display = 'none';
            
            try {
                // Start scan
                const response = await fetch('/api/scan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({target: targetPath, scan_type: scanType})
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const scanId = data.scan_id;
                
                // Poll for status
                const pollInterval = setInterval(async () => {
                    const statusResponse = await fetch(`/api/scan/${scanId}/status`);
                    const statusData = await statusResponse.json();
                    
                    if (statusData.status === 'completed') {
                        clearInterval(pollInterval);
                        document.getElementById('progressBar').style.width = '100%';
                        document.getElementById('progressBar').textContent = '100%';
                        document.getElementById('progressSection').style.display = 'none';
                        document.getElementById('scanResult').style.display = 'block';
                        document.getElementById('resultText').textContent = 
                            `Case ${statusData.case_id} created successfully!`;
                        document.getElementById('viewReportBtn').href = `/report/${statusData.case_id}`;
                    } else if (statusData.status === 'error') {
                        clearInterval(pollInterval);
                        document.getElementById('progressSection').style.display = 'none';
                        document.getElementById('scanError').style.display = 'block';
                        document.getElementById('errorText').textContent = statusData.error;
                    } else {
                        const progress = statusData.progress || 50;
                        document.getElementById('progressBar').style.width = progress + '%';
                        document.getElementById('progressBar').textContent = progress + '%';
                        document.getElementById('progressText').textContent = 
                            'Analyzing files... This may take a few minutes.';
                    }
                }, 1000);
                
            } catch (error) {
                document.getElementById('progressSection').style.display = 'none';
                document.getElementById('scanError').style.display = 'block';
                document.getElementById('errorText').textContent = error.message;
            }
        });
        
        // File browser functionality
        let currentBrowsePath = '';
        
        // Load directories when modal opens
        document.getElementById('browserModal').addEventListener('shown.bs.modal', function() {
            loadDirectories('');
        });
        
        async function loadDirectories(path) {
            currentBrowsePath = path;
            document.getElementById('currentPath').value = path || 'Select a drive...';
            
            try {
                const response = await fetch(`/api/browse?path=${encodeURIComponent(path)}`);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('browserContent').innerHTML = `
                        <div class="alert alert-danger">${data.error}</div>
                    `;
                    return;
                }
                
                const content = document.getElementById('browserContent');
                content.innerHTML = '';
                
                if (data.items.length === 0) {
                    content.innerHTML = '<div class="alert alert-info">No subdirectories found</div>';
                    return;
                }
                
                const list = document.createElement('div');
                list.className = 'list-group';
                
                data.items.forEach(item => {
                    const listItem = document.createElement('button');
                    listItem.className = 'list-group-item list-group-item-action';
                    listItem.innerHTML = `
                        <i class="bi bi-folder-fill text-warning"></i> ${item.name}
                    `;
                    listItem.onclick = () => loadDirectories(item.path);
                    list.appendChild(listItem);
                });
                
                content.appendChild(list);
            } catch (error) {
                console.error('Error loading directories:', error);
                document.getElementById('browserContent').innerHTML = `
                    <div class="alert alert-danger">Error loading directories</div>
                `;
            }
        }
        
        function goUp() {
            if (!currentBrowsePath) return;
            
            // For Windows paths
            const parts = currentBrowsePath.split('\\');
            if (parts.length > 1) {
                parts.pop();
                const parentPath = parts.join('\\');
                loadDirectories(parentPath || '');
            }
        }
        
        function selectCurrentPath() {
            if (currentBrowsePath) {
                document.getElementById('targetPath').value = currentBrowsePath;
                bootstrap.Modal.getInstance(document.getElementById('browserModal')).hide();
            } else {
                alert('Please select a directory first');
            }
        }
    </script>
</body>
</html>
